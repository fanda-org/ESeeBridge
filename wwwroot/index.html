<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-See Bridge</title>
    <script src="tailwindcss.js"></script>
    <script src="alpine.min.js" defer></script>
</head>
<body class="flex justify-center items-center min-h-screen bg-blue-100">
    <div class="container bg-gray-50 rounded-lg shadow-md overflow-hidden p-5" x-data="{ patientId: '', result: {}, isLoading: false, isShow: false }">
        <h1 class="text-3xl text-center font-bold pb-5">
            E-See Bridge
        </h1>
        <hr class="border-gray-400 mx-auto pb-2" />
        <div class="flex flex-col lg:flex-row gap-5">
            <div class="flex flex-col w-full gap-1"
                 x-data="{ info: {machineName: '', ipAddress: '', servicePort: 5200, listenerPort: -1}}"
                 x-init="info = await (await fetch('api/e-see/info', {method: 'GET', headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ZXNlZS1icmlkZ2U6QiF0OWF6aVM=' }})).json()">
                <h1 class="text-xl font-semibold">Information</h1>
                <div class="grid md:grid-cols-2 gap-2">
                    <div class="flex flex-col flex-grow">
                        <label>Machine Name:</label>
                        <input type="text" x-model="info.machineName" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                    </div>
                    <div class="flex flex-col flex-grow">
                        <label>IP Address:</label>
                        <input type="text" x-model="info.ipAddress" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                    </div>
                    <div class="flex flex-col flex-grow">
                        <label>Service Port:</label>
                        <input type="text" x-model="info.bridgeServicePort" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                    </div>
                    <div class="flex flex-col flex-grow">
                        <label>Listener Port:</label>
                        <input type="text" x-model="info.listenerPort" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                    </div>
                </div>
            </div>
            <div class="flex flex-col w-full gap-5">
                <div class="space-y-1">
                    <h1 class="text-xl font-semibold">Diagnose</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-0 gap-y-2 md:gap-2">
                        <div class="flex flex-col">
                            <label>Patient ID:</label>
                            <input type="text" x-model="patientId" class="border border-gray-400 rounded px-2 py-1 bg-white text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" autofocus/>
                        </div>
                        <div class="flex flex-col w-full justify-end">
                            <button 
                                x-bind:disabled="patientId.trim() === '' || isLoading" @click="isLoading=true; result={}; const pt = {id: patientId, name: '', age: 1, gender: ''}; result = await (await fetch('api/e-see/send-receive', {method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ZXNlZS1icmlkZ2U6QiF0OWF6aVM=' }, body: JSON.stringify(pt)} )).json(); isLoading=false;" 
                                class="bg-blue-500 hover:bg-blue-700 text-white font-semibold h-9 rounded cursor-pointer transition disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--<hr class="border-gray-400 mx-auto mt-5 mb-3" />-->
        <div class="space-y-2 mt-5">
            <h1 class="text-xl font-semibold">Results</h1>
            <!--<h1 x-show="isLoading">Loading...</h1>-->
            <div class="flex flex-wrap gap-x-3 w-full">
                <div class="flex flex-col flex-grow">
                    <label>Date:</label>
                    <input type="text" x-model="result.diagDate" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                </div>
                <div class="flex flex-col flex-grow">
                    <label>Device Name:</label>
                    <input type="text" x-model="result.deviceName" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                </div>
                <div class="flex flex-col flex-grow">
                    <label>Device Serial #:</label>
                    <input type="text" x-model="result.deviceSerialNumber" class="border border-gray-400 rounded px-2 py-1 bg-gray-100 text-gray-900 hover:border-blue-400 focus:outline-none focus:ring focus:ring-blue-500" readonly />
                </div>
            </div>
            <div class="overflow-x-auto border border-gray-400 rounded">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-2 text-left font-medium text-gray-800 tracking-wider border-b border-gray-400">Test #</th>
                            <th class="py-2 px-2 text-left font-medium text-gray-800 tracking-wider border-b border-gray-400">Sphere</th>
                            <th class="py-2 px-2 text-left font-medium text-gray-800 tracking-wider border-b border-gray-400">Cylinder</th>
                            <th class="py-2 px-2 text-left font-medium text-gray-800 tracking-wider border-b border-gray-400">Axis</th>
                            <th class="py-2 px-2 text-left font-medium text-gray-800 tracking-wider border-b border-gray-400">Sph.Equi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="py-2 text-gray-600 font-semibold text-center">Right Eye</td>
                        </tr>
                        <template x-for="reResult in result.rightEyeResults" :key="reResult.testNumber">
                            <tr class="hover:bg-gray-100">
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="reResult.testNumber"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="reResult.sphere"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="reResult.cylinder"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="reResult.axis"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="reResult.sphericalEquivalent"></td>
                            </tr>
                        </template>
                        <tr>
                            <td colspan="5" class="py-2 text-gray-600 font-semibold text-center">Left Eye</td>
                        </tr>
                        <template x-for="leResult in result.leftEyeResults" :key="leResult.testNumber">
                            <tr class="hover:bg-gray-100">
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="leResult.testNumber"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="leResult.sphere"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="leResult.cylinder"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="leResult.axis"></td>
                                <td class="py-2 px-2 whitespace-nowrap border-b border-gray-400" x-text="leResult.sphericalEquivalent"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <style>
        label {
            font-weight: 500;
            margin-bottom: 4px;
            color: oklch(27.8% 0.033 256.848);
        }
    </style>
    <!--<script>
        document.addEventListener("DOMContentLoaded", async function () {
            // Your JavaScript code here will execute once the DOM is ready.
            // For example, to add a click handler to a button with ID "myButton":
            document.getElementById("sendButton").addEventListener("click", async function () {
                //alert("Button clicked!");
                await sendAndReceivePatientInfo();
            });
            // await fetchInfo(); // Call the function to fetch data when the page loads
        });

        async function sendAndReceivePatientInfo() {
            const url = 'api/e-see/send-receive';

            try {
                const postData = {
                    id: document.getElementById("patientId").value,
                    name: "",
                    age: 1,
                    gender: "male"
                };

                const options = {
                    method: 'POST', // Specify the HTTP method as POST
                    headers: {
                        'Content-Type': 'application/json', // Indicate that the body is JSON
                    },
                    body: JSON.stringify(postData), // Convert the JavaScript object to a JSON string
                };

                //const response = await fetch(url);
                const response = await fetch(url, options);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json(); // Assuming the API returns JSON
                console.log(data);
                document.getElementById("diagDate").value = data.diagDate;
                document.getElementById("deviceName").value = data.deviceName;
                document.getElementById("deviceSerialNumber").value = data.deviceSerialNumber;
                // right
                document.getElementById("r-sphere").value = data.rightEyeResult.sphere;
                document.getElementById("r-cyl").value = data.rightEyeResult.cylinder;
                document.getElementById("r-axis").value = data.rightEyeResult.axis;
                document.getElementById("r-sphequi").value = data.rightEyeResult.sphericalEquivalent;
                // left
                document.getElementById("l-sphere").value = data.leftEyeResult.sphere;
                document.getElementById("l-cyl").value = data.leftEyeResult.cylinder;
                document.getElementById("l-axis").value = data.leftEyeResult.axis;
                document.getElementById("l-sphequi").value = data.leftEyeResult.sphericalEquivalent;

            } catch (error) {
                console.error('Error fetching data:', error);
                dataContainer.innerHTML = `<p style="color: red;">Failed to load data: ${error.message}</p>`;
            }
        }

        async function fetchInfo() {
            const url = 'api/e-see/info';

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json(); // Assuming the API returns JSON
                console.log(data);
                document.getElementById("machineName").value = data.machineName;
                document.getElementById("ipAddress").value = data.ipAddress;
                document.getElementById("servicePort").value = data.bridgeServicePort;
                document.getElementById("listenerPort").value = data.listenerPort;
            } catch (error) {
                console.error('Error fetching data:', error);
                dataContainer.innerHTML = `<p style="color: red;">Failed to load data: ${error.message}</p>`;
            }
        }
    </script>-->
</body>
</html>